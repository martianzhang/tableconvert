# CI/CD Pipeline for tableconvert
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test on Go ${{ matrix.go }} / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        go: ['1.23', '1.24', '1.25']
        os: [ubuntu-latest, macos-latest, windows-latest]
        exclude:
          # Reduce matrix size for faster runs
          - go: '1.23'
            os: macos-latest
          - go: '1.23'
            os: windows-latest
          - go: '1.24'
            os: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go ${{ matrix.go }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go }}
          cache: true

      - name: Run tests with coverage
        run: go test ./... -cover -race -timeout 10m

      - name: Build binary
        run: go build -o tableconvert ./cmd/tableconvert

      - name: Test binary
        run: |
          ./tableconvert --help > /dev/null
          ./tableconvert --help-formats > /dev/null
          echo "name,age\nAlice,30\nBob,25" | ./tableconvert --from=csv --to=json > /dev/null

      - name: Upload coverage
        if: matrix.os == 'ubuntu-latest' && matrix.go == '1.25'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella

  coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Generate coverage report
        run: |
          go test ./... -coverprofile=coverage.out -covermode=atomic
          go tool cover -func=coverage.out > coverage.txt
          echo "Coverage Summary:"
          cat coverage.txt | tail -1

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | tail -1 | awk '{print $3}' | sed 's/%//')
          echo "Total Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "❌ Coverage below 70% threshold"
            exit 1
          fi
          echo "✅ Coverage meets minimum threshold"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Run go fmt
        run: |
          FMT_OUTPUT=$(go fmt ./...)
          if [ -n "$FMT_OUTPUT" ]; then
            echo "Files need formatting:"
            echo "$FMT_OUTPUT"
            exit 1
          fi

      - name: Run go vet
        run: go vet ./...

      - name: Run go build
        run: go build ./...

  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [test, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Extract version and create release info
        id: release_info
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "go_version=$(go version)" >> $GITHUB_OUTPUT

      - name: Build binaries for release
        run: |
          mkdir -p release

          # Linux
          echo "Building Linux amd64..."
          GOOS=linux GOARCH=amd64 go build -trimpath -o release/tableconvert-linux-amd64 ./cmd/tableconvert
          echo "Building Linux arm64..."
          GOOS=linux GOARCH=arm64 go build -trimpath -o release/tableconvert-linux-arm64 ./cmd/tableconvert

          # macOS
          echo "Building macOS amd64..."
          GOOS=darwin GOARCH=amd64 go build -trimpath -o release/tableconvert-darwin-amd64 ./cmd/tableconvert
          echo "Building macOS arm64..."
          GOOS=darwin GOARCH=arm64 go build -trimpath -o release/tableconvert-darwin-arm64 ./cmd/tableconvert

          # Windows
          echo "Building Windows amd64..."
          GOOS=windows GOARCH=amd64 go build -trimpath -o release/tableconvert-windows-amd64.exe ./cmd/tableconvert

          # Generate checksums
          echo "Generating checksums..."
          cd release && sha256sum tableconvert-* > checksums.txt

          # Create release info file
          cat > release/RELEASE_INFO.txt << EOF
          tableconvert Release Info
          ========================

          Version: ${{ steps.release_info.outputs.version }}
          Built: ${{ steps.release_info.outputs.build_date }}
          ${{ steps.release_info.outputs.go_version }}

          Platform Support:
          - Linux (x64, ARM64)
          - macOS (x64, ARM64)
          - Windows (x64)

          Installation:
          # Linux/macOS
          chmod +x tableconvert-linux-*
          ./tableconvert-linux-amd64 --help

          # Windows
          .\tableconvert-windows-amd64.exe --help

          SHA256 Checksums:
          $(cat release/checksums.txt)
          EOF

      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          echo "## Changes in this release" > release/CHANGELOG.md
          echo "" >> release/CHANGELOG.md
          git log --oneline --decorate --no-merges $(git describe --tags --abbrev=0 2>/dev/null || echo HEAD~5)..HEAD 2>/dev/null | head -20 >> release/CHANGELOG.md || echo "No git history available" >> release/CHANGELOG.md

          # Add full changelog link
          echo "" >> release/CHANGELOG.md
          echo "## Full Changelog" >> release/CHANGELOG.md
          echo "https://github.com/${{ github.repository }}/compare/$(git describe --tags --abbrev=0 2>/dev/null || echo 'HEAD~5')...${{ github.ref_name }}" >> release/CHANGELOG.md

          # Set output
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat release/CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Release v${{ steps.release_info.outputs.version }}"
          body: |
            ## tableconvert v${{ steps.release_info.outputs.version }}

            ${{ steps.changelog.outputs.changelog }}

            ## Installation

            ### Linux
            ```bash
            chmod +x tableconvert-linux-amd64
            ./tableconvert-linux-amd64 --help
            ```

            ### macOS
            ```bash
            chmod +x tableconvert-darwin-amd64
            ./tableconvert-darwin-amd64 --help
            ```

            ### Windows
            ```powershell
            .\tableconvert-windows-amd64.exe --help
            ```

            ## Verification

            Verify checksums:
            ```bash
            sha256sum -c checksums.txt
            ```

            ## Build Info
            - Built: ${{ steps.release_info.outputs.build_date }}
            - ${{ steps.release_info.outputs.go_version }}
          files: |
            release/tableconvert-linux-amd64
            release/tableconvert-linux-arm64
            release/tableconvert-darwin-amd64
            release/tableconvert-darwin-arm64
            release/tableconvert-windows-amd64.exe
            release/checksums.txt
            release/RELEASE_INFO.txt
            release/CHANGELOG.md
          draft: false
          prerelease: false
          generate_release_notes: false