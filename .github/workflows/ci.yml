# CI/CD Pipeline for tableconvert
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test on Go ${{ matrix.go }} / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        go: ['1.23', '1.24', '1.25']
        os: [ubuntu-latest, macos-latest, windows-latest]
        exclude:
          # Reduce matrix size for faster runs
          - go: '1.23'
            os: macos-latest
          - go: '1.23'
            os: windows-latest
          - go: '1.24'
            os: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go ${{ matrix.go }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go }}
          cache: true

      - name: Run tests with coverage
        run: go test ./... -cover -race -timeout 10m

      - name: Build binary
        run: go build -o tableconvert ./cmd/tableconvert

      - name: Test binary
        run: |
          ./tableconvert --help > /dev/null
          ./tableconvert --help-formats > /dev/null
          echo "name,age\nAlice,30\nBob,25" | ./tableconvert --from=csv --to=json > /dev/null

      - name: Upload coverage
        if: matrix.os == 'ubuntu-latest' && matrix.go == '1.25'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella

  coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Generate coverage report
        run: |
          go test ./... -coverprofile=coverage.out -covermode=atomic
          go tool cover -func=coverage.out > coverage.txt
          echo "Coverage Summary:"
          cat coverage.txt | tail -1

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | tail -1 | awk '{print $3}' | sed 's/%//')
          echo "Total Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "❌ Coverage below 70% threshold"
            exit 1
          fi
          echo "✅ Coverage meets minimum threshold"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Run go fmt
        run: |
          FMT_OUTPUT=$(go fmt ./...)
          if [ -n "$FMT_OUTPUT" ]; then
            echo "Files need formatting:"
            echo "$FMT_OUTPUT"
            exit 1
          fi

      - name: Run go vet
        run: go vet ./...

      - name: Run go build
        run: go build ./...

  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [test, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build binaries for release
        run: |
          # Linux
          GOOS=linux GOARCH=amd64 go build -o tableconvert-linux-amd64 ./cmd/tableconvert
          GOOS=linux GOARCH=arm64 go build -o tableconvert-linux-arm64 ./cmd/tableconvert
          # macOS
          GOOS=darwin GOARCH=amd64 go build -o tableconvert-darwin-amd64 ./cmd/tableconvert
          GOOS=darwin GOARCH=arm64 go build -o tableconvert-darwin-arm64 ./cmd/tableconvert
          # Windows
          GOOS=windows GOARCH=amd64 go build -o tableconvert-windows-amd64.exe ./cmd/tableconvert

          # Create checksums
          sha256sum tableconvert-* > checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            tableconvert-linux-amd64
            tableconvert-linux-arm64
            tableconvert-darwin-amd64
            tableconvert-darwin-arm64
            tableconvert-windows-amd64.exe
            checksums.txt
          generate_release_notes: true
          draft: false
          prerelease: false